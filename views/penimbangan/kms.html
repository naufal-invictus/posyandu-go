<!DOCTYPE html>
<html lang="en">
<head>
    <title>Grafik KMS</title>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0-beta3/css/all.min.css">
    <style>
        .navbar-logo img { width: 50px; margin-right: 10px; }
        .navbar a { text-decoration: none; }
        .title { text-align: center; margin-top: 20px; font-size: 26px; margin-bottom: 20px; }
        body { display: flex; flex-direction: column; align-items: center; justify-content: center; height: 100vh; margin: 0; position: relative; }
        .navbar { position: fixed; top: 0; left: 0; right: 0; z-index: 1; }
        canvas { max-width: calc(60vw); max-height: calc(50vh); width: 100%; height: auto; margin-top: 60px; }
    </style>
</head>
<body>
    <div class="navbar navbar-expand-lg navbar-light bg-light">
        <div class="navbar-logo"><img src="/img/Favicon.png" alt="Posyandu Logo"></div>
        <a class="navbar-brand" href="#">Posyandu Melati</a>
        <ul class="navbar-menu navbar-nav ms-auto">
            <li class="nav-item"><a class="nav-link" href="/data_penimbangan?id_anak={{ .IDAnak }}">Kembali ke Data Penimbangan</a></li>
        </ul>
    </div>
    <div class="container mt-4"><h2 class="title">Grafik KMS & Imunisasi Anak</h2></div>
    <canvas id="myChart"></canvas>

    <script>
        var rawData = JSON.parse('{{ .JsonData }}');
        var rawRanges = JSON.parse('{{ .JsonRanges }}');

        var labels = rawData.map(item => item.umur);
        var values = rawData.map(item => item.berat_badan);
        var heights = rawData.map(item => item.tinggi_badan);
        var tooltips = rawData.map(item => item.tooltip);

        var normalLower = labels.map(umur => {
            var match = rawRanges.find(item => item.umur == umur);
            return match ? match.lower : null;
        });
        var normalUpper = labels.map(umur => {
            var match = rawRanges.find(item => item.umur == umur);
            return match ? match.upper : null;
        });

        var ctx = document.getElementById('myChart').getContext('2d');
        var myChart = new Chart(ctx, {
            type: 'line',
            data: {
                labels: labels,
                datasets: [
                    {
                        label: 'Berat Bayi (Kg)',
                        data: values,
                        fill: false,
                        borderColor: 'DarkCyan',
                        borderWidth: 2,
                        pointBackgroundColor: 'red',
                        pointRadius: 5,
                        yAxisID: 'y',
                    },
                    {
                        label: 'Tinggi Bayi (Cm)',
                        data: heights,
                        fill: false,
                        borderColor: 'Orange',
                        borderWidth: 2,
                        pointBackgroundColor: 'blue',
                        pointRadius: 5,
                        yAxisID: 'y1',
                    },
                    {
                        label: 'Batas Bawah Normal (BB)',
                        data: normalLower,
                        fill: false,
                        borderColor: 'rgb(255, 105, 180)',
                        borderWidth: 1,
                        borderDash: [5, 5],
                        yAxisID: 'y',
                    },
                    {
                        label: 'Batas Atas Normal (BB)',
                        data: normalUpper,
                        fill: false,
                        borderColor: 'DeepSkyBlue',
                        borderWidth: 1,
                        borderDash: [5, 5],
                        yAxisID: 'y',
                    }
                ]
            },
            options: {
                responsive: true,
                interaction: {
                    mode: 'index',
                    intersect: false,
                },
                plugins: {
                    tooltip: {
                        callbacks: {
                            label: function(context) {
                                var index = context.dataIndex;
                                var unit = context.dataset.label.includes('Tinggi') ? ' Cm' : ' Kg';
                                return tooltips[index] + ': ' + context.raw + unit;
                            }
                        }
                    }
                },
                scales: {
                    x: { title: { display: true, text: 'Usia (bulan)' }, beginAtZero: true },
                    y: { type: 'linear', display: true, position: 'left', title: { display: true, text: 'Berat (kg)' } },
                    y1: { type: 'linear', display: true, position: 'right', title: { display: true, text: 'Tinggi (cm)' }, grid: { drawOnChartArea: false } },
                }
            }
        });
    </script>
</body>
</html>
